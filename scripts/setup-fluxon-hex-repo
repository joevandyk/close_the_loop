#!/usr/bin/env bash
set -euo pipefail

# Idempotently configure the private Fluxon Hex repo.
#
# Requires:
#   - FLUXON_LICENSE_KEY
#   - FLUXON_KEY_FINGERPRINT (e.g. "SHA256:...")
#
# These should be injected via Doppler (not committed).

if [ -z "${FLUXON_LICENSE_KEY:-}" ]; then
  echo "✖ Missing FLUXON_LICENSE_KEY (expected via Doppler)" >&2
  exit 1
fi

if [ -z "${FLUXON_KEY_FINGERPRINT:-}" ]; then
  echo "✖ Missing FLUXON_KEY_FINGERPRINT (expected via Doppler)" >&2
  exit 1
fi

# Ensure Hex is installed so `mix hex.repo` is available.
mix local.hex --force --if-missing >/dev/null

# Re-add each time so changes to keys/fingerprint take effect.
mix hex.repo remove fluxon >/dev/null 2>&1 || true

mix hex.repo add fluxon https://repo.fluxonui.com \
  --fetch-public-key "${FLUXON_KEY_FINGERPRINT}" \
  --auth-key "${FLUXON_LICENSE_KEY}" >/dev/null

echo "✔ Fluxon Hex repo configured"

